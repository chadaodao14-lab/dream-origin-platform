name: æ¢¦ä¹‹æºå¹³å°è‡ªåŠ¨åŒ–éƒ¨ç½²

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - uses: actions/checkout@v3
    
    - name: ä½¿ç”¨ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: è¿è¡Œæµ‹è¯•
      run: npm test
    
    - name: æ„å»ºé¡¹ç›®
      run: npm run build

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: è®¾ç½® Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: npm ci
    
    - name: æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      run: npm run build
    
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT || '22' }}
        script: |
          cd /www/wwwroot/dreamsource
          
          # å¤‡ä»½å½“å‰ç‰ˆæœ¬
          if [ -d "backup" ]; then
            rm -rf backup_old
            mv backup backup_old
          fi
          cp -r . backup
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          git stash
          git pull origin main
          git stash pop
          
          # å®‰è£…ä¾èµ–
          npm install --production
          
          # é‡å¯æœåŠ¡
          pm2 reload ecosystem.config.js
          
          # æ¸…ç†ç¼“å­˜
          npm cache clean --force
          
          echo "éƒ¨ç½²å®Œæˆæ—¶é—´: $(date)"

  notification:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: å‘é€éƒ¨ç½²æˆåŠŸé€šçŸ¥
      uses: slackapi/slack-github-action@v1.23.0
      with:
        payload: |
          {
            "text": "âœ… æ¢¦ä¹‹æºåˆ›ä¸šæŠ•èµ„å¹³å°éƒ¨ç½²æˆåŠŸ",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "ğŸ‰ *æ¢¦ä¹‹æºå¹³å°éƒ¨ç½²æˆåŠŸ*\n\nâ€¢ éƒ¨ç½²åˆ†æ”¯: `${{ github.ref }}`\nâ€¢ éƒ¨ç½²æ—¶é—´: `$(date)`\nâ€¢ æäº¤ä¿¡æ¯: `${{ github.event.head_commit.message }}`"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}